---
title: ペイメントチャネルの作成方法 | JavaScriptでのXRPL開発 四段編
description: XRPL開発 四段編として、「ペイメントチャネルの作成方法」について解説しているページです。
sidebar:
  label: チャネルの作成方法
  order: 4
---

import { Aside, Steps } from '@astrojs/starlight/components';

この章では、ペイメントチャネルの作成方法について紹介します。

ペイメントチャネルは簡単にいうと、デポジットした分の`XRP`から支払いが後に発生する仕組みです。チャネルを作成し、事前にデポジットをすることで、オフチェーン支払いが可能になります。

また、XRPLのペイメントチャネル機能はスマートコントラクトや外部に依存したものではなく、ネイティブに提供されている機能のため、安全に取引を行えることが事前に保証（※）されており、開発者フレンドリーな機能となっています。

※XRPLのコアのバグは除きます。

## スクリプトの作成

<Steps>

1. プロジェクトディレクトリに`createPaymentChannel.js`という新しいファイルを作成します。
2. 以下のコードを`createAccounts.js`に貼り付けます。

    ```javascript
    import { xrpToDrops } from 'xrpl';
    import { client, aliceWallet, bobWallet } from './config.js';

    const createPaymentChannel = async () => {
        try {
            const tx = {
                TransactionType: 'PaymentChannelCreate', // トランザクションタイプ: PaymentChannelCreate
                Account: bobWallet.address, // 送金者（ボブ）のアカウントアドレス
                Amount: xrpToDrops('10'), // チャネルにデポジットするXRPの量（ここでは10 XRP）
                Destination: aliceWallet.address, // 受領者（アリス）のアカウントアドレス
                SettleDelay: 86400, // チャネルに資金がある場合でも後に閉じることが可能になる秒数（ここでは1日）
                PublicKey: bobWallet.publicKey, // 送金者（ボブ）の公開鍵
                CancelAfter: Math.floor(Date.now() / 1000) + 86400 * 7, // チャネルがキャンセルされるまでの秒数（ここでは1週間）
            };

            console.log('Submitting a PaymentChannelCreate transaction...');

            const paymentChannelResponse = await client.submitAndWait(tx, {
                wallet: bobWallet,
            });

            console.log(
                'PaymentChannelCreate transaction response:',
                paymentChannelResponse
            );

            // channel_idの取得
            const response = await client.request({
                command: 'account_channels',
                account: bobWallet.address,
            });

            const channel_id = response.result.channels[0].channel_id;
            console.log(`Created Payment Channel with ID: ${channel_id}`);

            return channel_id;
        } catch (error) {
            console.error('Error creating Payment Channel:', error);
        }
    };

    const main = async () => {
        try {
            await client.connect();
            const channelId = await createPaymentChannel();
        } catch (error) {
            console.error('Error connecting to XRPL:', error);
        } finally {
            await client.disconnect();
        }
    };

    main();
    ```
</Steps>


## スクリプトの実行

<Steps>

1. コマンドラインで以下のコマンドを実行して、スクリプトを実行します。

    ```bash
    node createPaymentChannel.js
    ```

2. 成功すれば、コンソールに以下が表示されます。
    ```bash
    Submitting a PaymentChannelCreate transaction...
    PaymentChannelCreate transaction response: {
    id: 10,
    result: {
        Account: 'rDBvi1AUpMGgwXJbqskC8wL3HnxwVnoCtC',
        Amount: '10000000',
        CancelAfter: 1719718213,
        Destination: 'rUqzzEHmo4EJqTRjdE557N9gjynWhbYB73',
        Fee: '12',
        Flags: 0,
        LastLedgerSequence: 1736663,
        PublicKey: 'EDECF7912AB2B111751AB9F849903EBA1E0F22E3A2734F9398DAF6916C53996E83',
        Sequence: 1724657,
        SettleDelay: 86400,
        SigningPubKey: 'EDECF7912AB2B111751AB9F849903EBA1E0F22E3A2734F9398DAF6916C53996E83',
        TransactionType: 'PaymentChannelCreate',
        TxnSignature: 'AEFC98BB2E4A78CC85D624D4562328882A763F11DEDB5448B9C3C0C06DDC33D7C515E64A9D03695F56B5F4AD978D23C70B2C4072C21477851E01D572065E9600',
        ctid: 'C01A7FC500000001',
        date: 772428613,
        hash: '61998DCE11B9975B56EC1228244D78568534F7BE24D60B439C6029CAB439341D',
        inLedger: 1736645,
        ledger_index: 1736645,
        meta: {
            AffectedNodes: [Array],
            TransactionIndex: 0,
            TransactionResult: 'tesSUCCESS'
        },
        validated: true
    },
    type: 'response'
    }
    Created Payment Channel with ID: E965B919E140BCF98280B29F6861C23BBB753B9D5515EDD57A285391BA20CCA2
    ```

    上記ログの最後に出力されたID（`E965B919E140BCF98280B29F6861C23BBB753B9D5515EDD57A285391BA20CCA2`）が`Channel ID`となりますので、控えておきましょう。

    <Aside>
    `channelId` は、XRPL（XRP Ledger）上でペイメントチャネルを一意に識別するためのIDです。
    このIDは、ペイメントチャネルを作成する際に生成され、チャネルの資金追加やクローズといった操作を行う際に必要となります。
    </Aside>

    ※実際の開発では取得したIDをそのまま引き継いでオフレジャー取引を行う必要があります。
</Steps>

次に、作成された`Channel ID`を使用してオフレジャー取引を行います。具体的な手順は次のセクションで解説します。  