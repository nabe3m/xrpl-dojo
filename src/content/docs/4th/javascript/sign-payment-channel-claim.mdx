---
title: オフレジャー支払いへの署名と検証 | JavaScriptでのXRPL開発 四段編
description: JavaScriptでのXRPL開発 四段編として、ペイメントチャネルの「オフレジャー支払いへの署名と検証」方法について解説しているページです。
sidebar:
  label: オフレジャー支払いへの署名と検証
  order: 5
---

import { Aside, Steps } from '@astrojs/starlight/components';

このガイドでは、オフレジャー支払いと署名、検証を行う方法について紹介します。

## スクリプトの作成

<Steps>

1. プロジェクトディレクトリに`signPaymentChannelClaim.js`という新しいファイルを作成します。
2. 以下のコードを`signPaymentChannelClaim.js`に貼り付けます。

    このコードは、1,000件の支払いを行うサンプルコードです。

    ※以下は、毎回`0.001`ずつ支払いが増えていき、最終的に最大`1 XRP`支払うループです。

    ```javascript
    // signPaymentChannelClaim.js
    import {
        signPaymentChannelClaim,
        verifyPaymentChannelClaim,
        xrpToDrops,
    } from 'xrpl';
    import { client, bobWallet } from './config.js';

    const signAndVerifyClaims = async (channel_id) => {
        let paychanSignature = '';

        console.time();
        for (let i = 1; i <= 1000; i++) {
            const amount = (0.001 * i).toFixed(6); // 小数点以下6桁に固定
            const amountFormatted = parseFloat(amount).toString(); // XRP建

            // 送金人: オフレジャー支払いへの署名
            paychanSignature = signPaymentChannelClaim(
                channel_id,
                amountFormatted, // XRP建の量での指定
                bobWallet.privateKey
            );

            // 受取人: オフレジャー支払い情報の検証
            if (
                !verifyPaymentChannelClaim(
                    channel_id,
                    amountFormatted, // XRP建の量での指定
                    paychanSignature,
                    bobWallet.publicKey
                )
            ) {
                throw new Error('Invalid signature');
            }
        }
        console.timeEnd();

        return paychanSignature;
    };

    const main = async () => {
        try {
            await client.connect();
            const channelId = 'チャネルID'; // 事前に作成したチャネルIDを入力
            const signature = await signAndVerifyClaims(channelId);
            console.log(`Generated signature: ${signature}`);
        } catch (error) {
            console.error('Error connecting to XRPL:', error);
        } finally {
            await client.disconnect();
        }
    };

    main();
    ```
</Steps>


## スクリプトの実行

<Steps>

1. コマンドラインで以下のコマンドを実行して、スクリプトを実行します。

    ```bash
    node signPaymentChannelClaim.js
    ```

2. 成功すれば、コンソールに以下が表示されます。
    ```bash
    default: 1.605s
    Generated signature: C0D5F6A9908EE8AF579912215C3B765835210194CD6183DCE9128F3E6EE0991D98068968675C7A5B3E50DEC7D52BBAC970BC2305F063E04E52B60752921CCA01
    ```

    1,000件のオフレジャー支払いにかかった時間はたったの`1.605s`です。（ローカル環境での結果となります）
    
    このように、オフレジャー取引を行うことで1,000件を超える支払いを数秒で処理することができます。

    <Aside>
    送金人がオフレジャー支払いに署名し、その署名を受取人が検証することで、オフレジャー支払いの有効性を確認します。このプロセスは、ペイメントチャネルを通じた支払いの一部として重要です。
    </Aside>
</Steps>

次に、資金を請求する方法について紹介します。